{
   "description": "Chain-focused view for NetScaler consumers - select chains to see routing topology and health",
   "graphTooltip": 1,
   "panels": [
      {
         "collapsed": false,
         "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
         },
         "id": 1,
         "title": "Topology",
         "type": "row"
      },
      {
         "datasource": {
            "type": "datasource",
            "uid": "-- Mixed --"
         },
         "description": "Routing topology: CS vServer -> LB vServer -> Service Group -> Server",
         "gridPos": {
            "h": 24,
            "w": 12,
            "x": 0,
            "y": 1
         },
         "id": 2,
         "options": {
            "edges": { },
            "layoutAlgorithm": "layered",
            "nodes": { },
            "zoomMode": "cooperative"
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "netscaler_topology_node{chain=~\".*$chain.*\"}",
               "format": "table",
               "instant": true,
               "interval": "1m",
               "legendFormat": "",
               "refId": "nodes"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "netscaler_topology_edge{chain=~\".*$chain.*\"}",
               "format": "table",
               "instant": true,
               "interval": "1m",
               "legendFormat": "",
               "refId": "edges"
            }
         ],
         "title": "Chain Topology",
         "type": "nodeGraph"
      },
      {
         "datasource": {
            "type": "datasource",
            "uid": "-- Mixed --"
         },
         "fieldConfig": {
            "defaults": {
               "mappings": [
                  {
                     "options": {
                        "0": {
                           "color": "red",
                           "text": "DOWN"
                        },
                        "1": {
                           "color": "green",
                           "text": "UP"
                        }
                     },
                     "type": "value"
                  }
               ],
               "thresholds": {
                  "mode": "absolute",
                  "steps": [
                     {
                        "color": "red",
                        "value": null
                     },
                     {
                        "color": "green",
                        "value": 1
                     }
                  ]
               }
            }
         },
         "gridPos": {
            "h": 4,
            "w": 12,
            "x": 12,
            "y": 1
         },
         "id": 3,
         "options": {
            "colorMode": "background",
            "graphMode": "none"
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "netscaler_cs_virtual_servers_state{virtual_server=~\"$chain\"}",
               "interval": "1m",
               "legendFormat": "CS: {{virtual_server}}"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "netscaler_virtual_servers_state{virtual_server=~\"$chain\"}",
               "interval": "1m",
               "legendFormat": "LB: {{virtual_server}}"
            }
         ],
         "title": "Chain Root State",
         "type": "stat"
      },
      {
         "datasource": {
            "type": "datasource",
            "uid": "-- Mixed --"
         },
         "fieldConfig": {
            "defaults": {
               "unit": "short"
            }
         },
         "gridPos": {
            "h": 4,
            "w": 6,
            "x": 12,
            "y": 5
         },
         "id": 4,
         "options": {
            "colorMode": "none",
            "graphMode": "area"
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "netscaler_cs_virtual_servers_total_hits{virtual_server=~\"$chain\"}",
               "interval": "1m",
               "legendFormat": "CS"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "netscaler_virtual_servers_total_hits{virtual_server=~\"$chain\"}",
               "interval": "1m",
               "legendFormat": "LB"
            }
         ],
         "title": "Total Hits",
         "type": "stat"
      },
      {
         "datasource": {
            "type": "datasource",
            "uid": "-- Mixed --"
         },
         "fieldConfig": {
            "defaults": {
               "unit": "short"
            }
         },
         "gridPos": {
            "h": 4,
            "w": 6,
            "x": 18,
            "y": 5
         },
         "id": 5,
         "options": {
            "colorMode": "none",
            "graphMode": "area"
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "netscaler_cs_virtual_servers_current_client_connections{virtual_server=~\"$chain\"}",
               "interval": "1m",
               "legendFormat": "CS Client"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "netscaler_virtual_servers_current_client_connections{virtual_server=~\"$chain\"}",
               "interval": "1m",
               "legendFormat": "LB Client"
            }
         ],
         "title": "Active Connections",
         "type": "stat"
      },
      {
         "datasource": {
            "type": "datasource",
            "uid": "-- Mixed --"
         },
         "gridPos": {
            "h": 16,
            "w": 12,
            "x": 12,
            "y": 9
         },
         "id": 6,
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "netscaler_topology_node{chain=~\".*$chain.*\"}",
               "format": "table",
               "instant": true,
               "interval": "1m",
               "legendFormat": ""
            }
         ],
         "title": "Chain Components",
         "transformations": [
            {
               "id": "filterFieldsByName",
               "options": {
                  "include": {
                     "pattern": "^(title|node_type|state)$"
                  }
               }
            },
            {
               "id": "organize",
               "options": {
                  "indexByName": {
                     "node_type": 0,
                     "state": 2,
                     "title": 1
                  },
                  "renameByName": {
                     "node_type": "Type",
                     "state": "State",
                     "title": "Component"
                  }
               }
            }
         ],
         "type": "table"
      },
      {
         "collapsed": false,
         "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 25
         },
         "id": 7,
         "panels": [ ],
         "title": "LB Virtual Servers",
         "type": "row"
      },
      {
         "datasource": {
            "type": "datasource",
            "uid": "-- Mixed --"
         },
         "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 26
         },
         "id": 8,
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "max by (virtual_server) (netscaler_virtual_servers_state{virtual_server=~\"$lbvserver\"})",
               "format": "table",
               "instant": true,
               "interval": "1m",
               "legendFormat": "",
               "refId": "A"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "max by (virtual_server) (netscaler_virtual_servers_health{virtual_server=~\"$lbvserver\"})",
               "format": "table",
               "instant": true,
               "interval": "1m",
               "legendFormat": "",
               "refId": "B"
            }
         ],
         "title": "LB vServer States",
         "transformations": [
            {
               "id": "joinByField",
               "options": {
                  "byField": "virtual_server",
                  "mode": "outer"
               }
            },
            {
               "id": "filterFieldsByName",
               "options": {
                  "include": {
                     "pattern": "^(virtual_server|Value #[AB])$"
                  }
               }
            },
            {
               "id": "organize",
               "options": {
                  "indexByName": {
                     "Value #A": 1,
                     "Value #B": 2,
                     "virtual_server": 0
                  },
                  "renameByName": {
                     "Value #A": "State",
                     "Value #B": "Health %",
                     "virtual_server": "LB vServer"
                  }
               }
            }
         ],
         "type": "table"
      },
      {
         "datasource": {
            "type": "datasource",
            "uid": "-- Mixed --"
         },
         "fieldConfig": {
            "defaults": {
               "max": 100,
               "min": 0,
               "thresholds": {
                  "mode": "absolute",
                  "steps": [
                     {
                        "color": "red",
                        "value": null
                     },
                     {
                        "color": "yellow",
                        "value": 50
                     },
                     {
                        "color": "green",
                        "value": 100
                     }
                  ]
               },
               "unit": "percent"
            }
         },
         "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 34
         },
         "id": 9,
         "options": {
            "displayMode": "gradient",
            "orientation": "horizontal"
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "max by (virtual_server) (netscaler_virtual_servers_health{virtual_server=~\"$lbvserver\"})",
               "interval": "1m",
               "legendFormat": "{{virtual_server}}"
            }
         ],
         "title": "LB vServer Health",
         "type": "bargauge"
      },
      {
         "datasource": {
            "type": "datasource",
            "uid": "-- Mixed --"
         },
         "fieldConfig": {
            "defaults": {
               "unit": "short"
            }
         },
         "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 42
         },
         "id": 10,
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "max by (virtual_server) (netscaler_virtual_servers_active_services{virtual_server=~\"$lbvserver\"})",
               "interval": "1m",
               "legendFormat": "{{virtual_server}} Active"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "max by (virtual_server) (netscaler_virtual_servers_inactive_services{virtual_server=~\"$lbvserver\"})",
               "interval": "1m",
               "legendFormat": "{{virtual_server}} Inactive"
            }
         ],
         "title": "Active / Inactive Services",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "datasource",
            "uid": "-- Mixed --"
         },
         "fieldConfig": {
            "defaults": {
               "unit": "reqps"
            }
         },
         "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 50
         },
         "id": 11,
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "max by (virtual_server) (rate(netscaler_virtual_servers_total_requests{virtual_server=~\"$lbvserver\"}[$__rate_interval]))",
               "interval": "1m",
               "legendFormat": "{{virtual_server}}"
            }
         ],
         "title": "LB Requests",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "datasource",
            "uid": "-- Mixed --"
         },
         "fieldConfig": {
            "defaults": {
               "unit": "Bps"
            }
         },
         "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 58
         },
         "id": 12,
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "max by (virtual_server) (rate(netscaler_virtual_servers_total_request_bytes{virtual_server=~\"$lbvserver\"}[$__rate_interval]))",
               "interval": "1m",
               "legendFormat": "{{virtual_server}} RX"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "max by (virtual_server) (rate(netscaler_virtual_servers_total_response_bytes{virtual_server=~\"$lbvserver\"}[$__rate_interval]))",
               "interval": "1m",
               "legendFormat": "{{virtual_server}} TX"
            }
         ],
         "title": "LB Traffic",
         "type": "timeseries"
      },
      {
         "collapsed": true,
         "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 66
         },
         "id": 13,
         "panels": [
            {
               "datasource": {
                  "type": "datasource",
                  "uid": "-- Mixed --"
               },
               "gridPos": {
                  "h": 8,
                  "w": 24,
                  "x": 0,
                  "y": 0
               },
               "id": 14,
               "pluginVersion": "v11.4.0",
               "targets": [
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "max by (servicegroup, member, port) (netscaler_servicegroup_state{servicegroup=~\"$servicegroup\"})",
                     "format": "table",
                     "instant": true,
                     "interval": "1m",
                     "legendFormat": "",
                     "refId": "A"
                  },
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "max by (servicegroup, member, port) (netscaler_servicegroup_average_time_to_first_byte{servicegroup=~\"$servicegroup\"})",
                     "format": "table",
                     "instant": true,
                     "interval": "1m",
                     "legendFormat": "",
                     "refId": "B"
                  }
               ],
               "title": "Service Group Members",
               "transformations": [
                  {
                     "id": "joinByField",
                     "options": {
                        "byField": "member",
                        "mode": "outer"
                     }
                  },
                  {
                     "id": "filterFieldsByName",
                     "options": {
                        "include": {
                           "pattern": "^(servicegroup|member|port|Value #[AB])$"
                        }
                     }
                  },
                  {
                     "id": "organize",
                     "options": {
                        "indexByName": {
                           "Value #A": 3,
                           "Value #B": 4,
                           "member": 1,
                           "port": 2,
                           "servicegroup": 0
                        },
                        "renameByName": {
                           "Value #A": "State",
                           "Value #B": "TTFB (ms)",
                           "member": "Member",
                           "port": "Port",
                           "servicegroup": "Service Group"
                        }
                     }
                  }
               ],
               "type": "table"
            },
            {
               "datasource": {
                  "type": "datasource",
                  "uid": "-- Mixed --"
               },
               "fieldConfig": {
                  "defaults": {
                     "thresholds": {
                        "mode": "absolute",
                        "steps": [
                           {
                              "color": "green",
                              "value": null
                           },
                           {
                              "color": "yellow",
                              "value": 100
                           },
                           {
                              "color": "red",
                              "value": 500
                           }
                        ]
                     },
                     "unit": "ms"
                  }
               },
               "gridPos": {
                  "h": 8,
                  "w": 24,
                  "x": 0,
                  "y": 0
               },
               "id": 15,
               "options": {
                  "displayMode": "gradient",
                  "orientation": "horizontal"
               },
               "pluginVersion": "v11.4.0",
               "targets": [
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "max by (servicegroup, member, port) (netscaler_servicegroup_average_time_to_first_byte{servicegroup=~\"$servicegroup\"})",
                     "interval": "1m",
                     "legendFormat": "{{member}}:{{port}}"
                  }
               ],
               "title": "TTFB per Member",
               "type": "bargauge"
            },
            {
               "datasource": {
                  "type": "datasource",
                  "uid": "-- Mixed --"
               },
               "fieldConfig": {
                  "defaults": {
                     "unit": "reqps"
                  }
               },
               "gridPos": {
                  "h": 8,
                  "w": 24,
                  "x": 0,
                  "y": 0
               },
               "id": 16,
               "pluginVersion": "v11.4.0",
               "targets": [
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "max by (servicegroup, member, port) (rate(netscaler_servicegroup_total_requests{servicegroup=~\"$servicegroup\"}[$__rate_interval]))",
                     "interval": "1m",
                     "legendFormat": "{{member}}:{{port}}"
                  }
               ],
               "title": "Member Requests",
               "type": "timeseries"
            },
            {
               "datasource": {
                  "type": "datasource",
                  "uid": "-- Mixed --"
               },
               "fieldConfig": {
                  "defaults": {
                     "unit": "short"
                  }
               },
               "gridPos": {
                  "h": 8,
                  "w": 24,
                  "x": 0,
                  "y": 0
               },
               "id": 17,
               "pluginVersion": "v11.4.0",
               "targets": [
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "max by (servicegroup, member, port) (netscaler_servicegroup_current_server_connections{servicegroup=~\"$servicegroup\"})",
                     "interval": "1m",
                     "legendFormat": "{{member}}:{{port}}"
                  }
               ],
               "title": "Member Connections",
               "type": "timeseries"
            }
         ],
         "title": "Service Groups",
         "type": "row"
      },
      {
         "collapsed": true,
         "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 67
         },
         "id": 18,
         "panels": [
            {
               "datasource": {
                  "type": "datasource",
                  "uid": "-- Mixed --"
               },
               "gridPos": {
                  "h": 8,
                  "w": 24,
                  "x": 0,
                  "y": 0
               },
               "id": 19,
               "pluginVersion": "v11.4.0",
               "targets": [
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "max by (title, state) (netscaler_topology_node{chain=~\".*$chain.*\",node_type=\"server\"})",
                     "format": "table",
                     "instant": true,
                     "interval": "1m",
                     "legendFormat": ""
                  }
               ],
               "title": "Backend Server States",
               "transformations": [
                  {
                     "id": "filterFieldsByName",
                     "options": {
                        "include": {
                           "pattern": "^(title|state)$"
                        }
                     }
                  },
                  {
                     "id": "organize",
                     "options": {
                        "indexByName": {
                           "state": 1,
                           "title": 0
                        },
                        "renameByName": {
                           "state": "State",
                           "title": "Server"
                        }
                     }
                  }
               ],
               "type": "table"
            },
            {
               "datasource": {
                  "type": "datasource",
                  "uid": "-- Mixed --"
               },
               "gridPos": {
                  "h": 8,
                  "w": 24,
                  "x": 0,
                  "y": 0
               },
               "id": 20,
               "options": {
                  "colorMode": "none",
                  "graphMode": "none"
               },
               "pluginVersion": "v11.4.0",
               "targets": [
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "count(max by (title) (netscaler_topology_node{chain=~\".*$chain.*\",node_type=\"server\",state=\"UP\"})) or vector(0)",
                     "interval": "1m",
                     "legendFormat": "UP"
                  },
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "count(max by (title) (netscaler_topology_node{chain=~\".*$chain.*\",node_type=\"server\"})) or vector(0)",
                     "interval": "1m",
                     "legendFormat": "Total"
                  }
               ],
               "title": "Servers UP",
               "type": "stat"
            },
            {
               "datasource": {
                  "type": "datasource",
                  "uid": "-- Mixed --"
               },
               "fieldConfig": {
                  "defaults": {
                     "color": {
                        "fixedColor": "red",
                        "mode": "fixed"
                     }
                  }
               },
               "gridPos": {
                  "h": 8,
                  "w": 24,
                  "x": 0,
                  "y": 0
               },
               "id": 21,
               "pluginVersion": "v11.4.0",
               "targets": [
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "max by (title) (netscaler_topology_node{chain=~\".*$chain.*\",node_type=\"server\",state=\"DOWN\"})",
                     "format": "table",
                     "instant": true,
                     "interval": "1m",
                     "legendFormat": ""
                  }
               ],
               "title": "Down Servers",
               "transformations": [
                  {
                     "id": "filterFieldsByName",
                     "options": {
                        "include": {
                           "pattern": "^title$"
                        }
                     }
                  },
                  {
                     "id": "organize",
                     "options": {
                        "renameByName": {
                           "title": "Server"
                        }
                     }
                  }
               ],
               "type": "table"
            }
         ],
         "title": "Backend Servers",
         "type": "row"
      }
   ],
   "refresh": "1m",
   "schemaVersion": 39,
   "templating": {
      "list": [
         {
            "label": "Data source",
            "name": "datasource",
            "query": "prometheus",
            "type": "datasource"
         },
         {
            "datasource": {
               "type": "prometheus",
               "uid": "${datasource}"
            },
            "label": "Environment",
            "name": "environment",
            "query": "label_values(netscaler_topology_node{chain!=\"\"}, deployment_environment_name)",
            "refresh": "time",
            "type": "query"
         },
         {
            "allowCustomValue": true,
            "datasource": {
               "type": "prometheus",
               "uid": "${datasource}"
            },
            "label": "Chain",
            "multi": true,
            "name": "chain",
            "query": "label_values(netscaler_topology_node{deployment_environment_name=~\"$environment\",chain!=\"\"}, chain)",
            "refresh": "time",
            "type": "query"
         },
         {
            "datasource": {
               "type": "prometheus",
               "uid": "${datasource}"
            },
            "includeAll": true,
            "label": "LB vServer",
            "multi": true,
            "name": "lbvserver",
            "query": "label_values(netscaler_topology_node{deployment_environment_name=~\"$environment\",chain=~\".*$chain.*\",node_type=\"lbvserver\"}, title)",
            "refresh": "time",
            "type": "query"
         },
         {
            "datasource": {
               "type": "prometheus",
               "uid": "${datasource}"
            },
            "includeAll": true,
            "label": "Service Group",
            "multi": true,
            "name": "servicegroup",
            "query": "label_values(netscaler_topology_node{deployment_environment_name=~\"$environment\",chain=~\".*$chain.*\",node_type=\"servicegroup\"}, title)",
            "refresh": "time",
            "type": "query"
         }
      ]
   },
   "time": {
      "from": "now-1h",
      "to": "now"
   },
   "timezone": "browser",
   "title": "NetScaler Chain",
   "uid": "netscaler-chain"
}
